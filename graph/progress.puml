@startuml progress
start
partition 微信消息处理流程 {
    :微信服务器发送请求;
    if (请求方法?) then (GET)
        partition 签名验证 {
            :验证签名;
            if (验证成功?) then (是)
                :返回echostr;
                stop
            else (否)
                :返回403错误;
                stop
            endif
        }
    else (POST)
        partition 消息处理 {
            :接收原始数据;
            :解析XML;
            if (解析成功?) then (是)
                :提取加密内容;
                :消息解密;
                if (解密成功?) then (是)
                    :解析消息内容;
                    ' :构造回复消息;

                    partition 外部服务调用接口 {
                        :发送JSON请求到外部服务;
                        fork
                            :等待响应(5秒超时);
                        fork again
                            :超时计时;
                        end fork

                        if (收到响应?) then (是)
                            if (响应包含内容?) then (是)
                                :获取回复内容;
                            else (否)
                                :标记空响应;
                            endif
                        else (否)
                            :记录超时日志;
                            :标记超时状态;
                        endif
                    }

                    if (需要回复?) then (是)
                        :加密回复;
                        if (加密成功?) then (是)
                            :生成签名;
                            :返回加密响应;
                            stop
                        else (否)
                            :记录加密失败;
                        endif
                    else (否)
                        :直接返回success;
                        stop
                    endif
                else (否)
                    :记录解密失败;
                endif
            else (否)
                :记录解析失败;
            endif
        }

        partition 异常处理 {
            :记录错误日志;
            if (超时或空响应?) then (是)
                :返回success;
            else (否)
                :返回500错误;
            endif
            stop
        }
    endif
}

partition 日志系统 {
    :记录验证过程;
    :记录原始数据;
    :记录解密结果;
    :记录外部调用;
    :记录响应状态;
    :记录最终响应;
}

@enduml